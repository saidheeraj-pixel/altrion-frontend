import{u as h,b as S}from"./state-1cba2Yyk.js";import{a as w,R as f}from"./index-DmE6YkWe.js";import{u as y}from"./vendor-CInILLWq.js";const d="/api";class o extends Error{status;statusText;data;constructor(e,a,s){super(`API Error: ${e} ${a}`),this.name="ApiError",this.status=e,this.statusText=a,this.data=s}}const A=()=>{try{const t=localStorage.getItem("altrion-auth");if(t)return JSON.parse(t).state?.token||null}catch{return null}return null},i=t=>{const e=A(),a=new Headers(t.headers);return a.set("Content-Type","application/json"),e&&a.set("Authorization",`Bearer ${e}`),{...t,headers:a}},c=async t=>{if(!t.ok){let a;try{a=await t.json()}catch{a=null}throw new o(t.status,t.statusText,a)}return{data:await t.json(),status:t.status,headers:t.headers}},u=async(t,e)=>{const{timeout:a=3e4,...s}=e,r=new AbortController,n=setTimeout(()=>r.abort(),a);try{return await fetch(t,{...s,signal:r.signal})}finally{clearTimeout(n)}},l=(t,e)=>{const a=d.endsWith("/")?d.slice(0,-1):d,s=t.startsWith("/")?t:`/${t}`;let r=`${a}${s}`;if(e&&Object.keys(e).length>0){const n=new URLSearchParams(e);r+=`?${n.toString()}`}return r},m={async get(t,e={}){const a=l(t,e.params),s=i({...e,method:"GET"}),r=await u(a,s);return c(r)},async post(t,e,a={}){const s=l(t,a.params),r=i({...a,method:"POST",body:e?JSON.stringify(e):void 0}),n=await u(s,r);return c(n)},async put(t,e,a={}){const s=l(t,a.params),r=i({...a,method:"PUT",body:e?JSON.stringify(e):void 0}),n=await u(s,r);return c(n)},async patch(t,e,a={}){const s=l(t,a.params),r=i({...a,method:"PATCH",body:e?JSON.stringify(e):void 0}),n=await u(s,r);return c(n)},async delete(t,e={}){const a=l(t,e.params),s=i({...e,method:"DELETE"}),r=await u(a,s);return c(r)}},p=t=>({user:{id:t.data.user.id,email:t.data.user.email,name:t.data.user.name,displayName:t.data.user.name?.split(" ")[0]||t.data.user.email.split("@")[0],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},tokens:{accessToken:t.data.accessToken,refreshToken:t.data.refreshToken,expiresAt:Date.now()+10080*60*1e3}}),T=t=>({id:t.user.id,email:t.user.email,name:t.user.name,displayName:t.user.name?.split(" ")[0]||t.user.email.split("@")[0],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}),g={async login(t){try{const{data:e}=await m.post("/auth/signin",{email:t.email,password:t.password});return p(e)}catch(e){if(e instanceof o){const s=e.data?.message||"Invalid credentials";throw new o(e.status,s)}throw e}},async signup(t){try{const{data:e}=await m.post("/auth/signup",{email:t.email,password:t.password,name:t.name});return p(e)}catch(e){if(e instanceof o){const s=e.data?.message||"Registration failed";throw new o(e.status,s)}throw e}},async logout(){try{await m.post("/auth/logout")}catch(t){console.warn("Logout API call failed:",t)}},async refreshToken(t){return{user:await this.getCurrentUser(),tokens:{accessToken:t,refreshToken:t,expiresAt:Date.now()+10080*60*1e3}}},async getCurrentUser(){const{data:t}=await m.get("/auth/me");return T(t.data)},async forgotPassword(t){throw new o(501,"Password reset not implemented yet")},async resetPassword(t,e){throw new o(501,"Password reset not implemented yet")},async oauthLogin(t){return`http://localhost:3000/api/auth/${t}`}};function C(){const t=y(),{login:e,setLoading:a,setError:s}=w();return h({mutationFn:r=>g.login(r),onMutate:()=>{a(!0),s(null)},onSuccess:r=>{e(r.user,r.tokens.accessToken),t(f.DASHBOARD)},onError:r=>{s(r.message)},onSettled:()=>{a(!1)}})}function L(){const t=y(),{logout:e}=w(),a=S();return h({mutationFn:()=>g.logout(),onSuccess:()=>{e(),a.clear(),localStorage.removeItem("altrion-displayName"),localStorage.removeItem("altrion-connected-accounts"),t(f.LOGIN)}})}function E(){return h({mutationFn:t=>g.oauthLogin(t),onSuccess:t=>{window.location.href=t}})}export{E as a,L as b,C as u};
